<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css', v=1) }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css', v=1) }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css', v=1) }}">
    <title>Find a Helper</title>
</head>

<body>
    <nav class="navbar">
        <a href="{{ url_for('index') }}" class="logo">Find a Helper</a>
        <ul class="nav-links">
            <li class="nav-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="nav-item"><a href="{{ url_for('tasks') }}">Tasks</a></li>
            <li class="nav-item"><a href="{{ url_for('messages') }}">Messages</a></li>
            <li class="nav-item"><a href="{{ url_for('userProfile') }}">User Profile</a></li>
        </ul>
    </nav>
    <div id="map"></div>

    <!-- AI Chat Widget -->
    <button id="chat-toggle" class="chat-toggle" title="AI Assistant">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
        </svg>
    </button>

    <div id="chat-panel" class="chat-panel">
        <div class="chat-header">
            <div>
                <div class="chat-header-title">AI Assistant</div>
                <div class="chat-header-subtitle">Ask me anything about tasks</div>
            </div>
            <div class="chat-header-actions">
                <button id="chat-clear" class="chat-clear" title="Clear chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
                <button id="chat-close" class="chat-close">&times;</button>
            </div>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input-area">
            <input id="chat-input" class="chat-input" type="text" placeholder="Type a message..." autocomplete="off">
            <button id="chat-send" class="chat-send">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Post Task Button (Everyone) -->
    <button id="post-task-btn" class="fab-left" title="Post a Task">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <!-- Post Task Modal -->
    <div id="post-task-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <form id="post-task-form">
                <h3>Post a New Task</h3>
                <div class="form-group">
                    <label for="task-title">Task Title</label>
                    <input type="text" id="task-title" required placeholder="e.g. Move a couch">
                </div>
                <div class="form-group">
                    <label for="task-desc">Description</label>
                    <textarea id="task-desc" required placeholder="Describe what you need help with..."></textarea>
                </div>
                <div class="form-group">
                    <label for="task-reward">Reward ($)</label>
                    <input type="number" id="task-reward" min="0" required placeholder="50">
                </div>
                <button type="submit" class="btn-submit">Post Task</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('post-task-modal');
            const btn = document.getElementById('post-task-btn');
            const span = document.querySelector('.close-modal');
            const form = document.getElementById('post-task-form');

            if (btn) {
                btn.onclick = () => modal.style.display = "block";
            }
            if (span) {
                span.onclick = () => modal.style.display = "none";
            }
            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            if (form) {
                form.onsubmit = (e) => {
                    e.preventDefault();

                    const title = document.getElementById('task-title').value;
                    const desc = document.getElementById('task-desc').value;
                    const reward = document.getElementById('task-reward').value;

                    // Get location logic
                    let lat, lng;
                    // Try to get myLocation from map.js global variable
                    if (typeof myLocation !== 'undefined' && myLocation) {
                        lat = myLocation.lat;
                        lng = myLocation.lng;
                    } else if (typeof map !== 'undefined') {
                        const center = map.getCenter();
                        lat = center.lat;
                        lng = center.lng;
                    } else {
                        alert("Map not initialized, cannot get location. Please wait for map to load.");
                        return;
                    }

                    fetch('/api/post_task', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: title,
                            description: desc,
                            reward: reward,
                            lat: lat,
                            lng: lng
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                alert('Task Posted Successfully! Look for the GREEN marker on the map.');
                                modal.style.display = "none";
                                form.reset();

                                // Refresh map using loadNearbyTasks from map.js
                                if (typeof loadNearbyTasks === 'function' && typeof L !== 'undefined') {
                                    loadNearbyTasks(L.latLng(lat, lng));
                                } else {
                                    // Fallback if function not found
                                    location.reload();
                                }
                            } else {
                                alert('Error posting task: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert('Error posting task. Check console.');
                        });
                };
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="{{ url_for('static', filename='js/map.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
</body>

</html>